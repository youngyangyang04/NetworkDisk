# 文件上传接口修复说明

## 问题描述
文件上传时，接口中的 authorization 和其他接口的不同，导致后端接口校验不通过。

## 问题原因分析

### 1. Token 存储不一致
- **用户 Store 中的 token**：存储在 `Cookies.get('token')` 中
- **Cookie 工具中的 token**：存储在 `Cookies.get('login_token')` 中
- 这导致上传接口和其他接口使用不同的 token

### 2. API 地址配置错误
- `common.js` 中的 `getUrlPrefix()` 返回 `http://localhost:5173`（前端开发服务器地址）
- 应该使用相对路径，通过 Vite 代理转发到后端

### 3. API 路径不一致
- 上传配置中的路径与其他 API 文件中的路径不匹配

## 修复内容

### 1. 统一 Token 管理
```javascript
// 修改前：使用 cookie.js 中的 getToken()
headers: {
  Authorization: getToken()
}

// 修改后：使用用户 store 中的 token，并统一格式
headers: function () {
  return {
    Authorization: `${userStore.token}`
  }
}
```

### 2. 移除冗余的 API 地址配置
```javascript
// 修改前：在代码中维护后端地址
getUrlPrefix() {
  return 'http://localhost:5173'
}

// 修改后：完全移除 getUrlPrefix 函数，直接使用相对路径
// 通过 vite.config.js 中的代理配置统一管理后端地址
```

### 3. 统一 API 路径
```javascript
// 修改前：使用 getUrlPrefix() 拼接路径
target: function (file, chunk) {
  if (panUtil.getChunkUploadSwitch()) {
    return panUtil.getUrlPrefix() + '/api/v1/files/file/chunk-upload'
  }
  return panUtil.getUrlPrefix() + '/api/v1/files/file/upload'
}

// 修改后：直接使用相对路径
target: function (file, chunk) {
  if (panUtil.getChunkUploadSwitch()) {
    return '/api/v1/files/file/chunk-upload'
  }
  return '/api/v1/files/file/upload'
}
```

### 4. 更新依赖导入
```javascript
// 移除
import { getToken } from '@/utils/cookie.js'

// 添加
import { useUserStore } from '@/stores/user.js'
```

### 5. 清理冗余配置
```javascript
// 移除 getUrlPrefix 函数，不再在代码中维护后端地址
// 移除 getPreviewUrl 中的硬编码 authorization 参数
// 统一通过 vite.config.js 中的代理配置管理后端地址
```

## 修复后的效果

1. **Token 一致性**：所有接口都使用用户 store 中的 token
2. **Authorization 格式统一**：所有接口都使用 `${userStore.token}` 格式
3. **配置简化**：不再在代码中维护后端地址，统一通过 vite.config.js 管理
4. **路径统一**：上传接口路径与其他 API 保持一致
5. **后端校验通过**：authorization 头正确传递
6. **维护性提升**：后端地址变更时只需修改 vite.config.js

## 验证方法

1. 登录后检查浏览器开发者工具中的网络请求
2. 确认上传请求的 Authorization 头与其他请求一致
3. 验证上传功能正常工作
4. 检查后端日志确认 token 校验通过
5. 检查所有接口的 Authorization 头格式是否统一为 `${userStore.token}`
